<div id="graph"></div>
<script>

  const graphData = {{ graph_data | tojson }};

  const Graph = ForceGraph()(document.getElementById('graph'))
    .backgroundColor('#F5F5FF')
    .height(window.innerHeight - 60)
    .graphData(graphData)
    .nodeCanvasObject((node, ctx, globalScale) => {
      const label = node.username;
      const fontSize = 12 / globalScale;
      const imgSize = 28;
      ctx.font = `${fontSize}px Sans-Serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      // Draw avatar images
      if (node.avatar && node.img) {
        ctx.drawImage(node.img, node.x - imgSize / 2, node.y - imgSize / 2, imgSize, imgSize);
      } else if (node.avatar && !node.img) {
        const img = new Image();
        img.src = node.avatar;
        img.onload = () => {
          node.img = img;
          ctx.drawImage(img, node.x - imgSize / 2, node.y - imgSize / 2, imgSize, imgSize);
        };
      }

      // Draw labels
      ctx.fillStyle = (node.type === 'follower') ? 'red' : 'blue'; 
      ctx.fillText(label, node.x, node.y + imgSize / 2 + 5);

    })
    .onNodeClick(node => console.log(node));

  // Configuration for forces
  Graph.d3Force('charge', d3.forceManyBody().strength(-120));
  Graph.d3Force('link', d3.forceLink().distance(140));

  elementResizeDetectorMaker().listenTo(
    document.getElementById('graph'),
    el => Graph.width(el.offsetWidth)
  );
  
  function filterNodes(filterType) {
    Graph.graphData().nodes.forEach(node => {
        node.hidden = (filterType !== 'all' && node.type !== filterType); // Hide nodes not matching the filterType
    });
    Graph.graphData(Graph.graphData()); // Re-trigger the graph rendering with updated visibility
  }
  
</script>