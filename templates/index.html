<!DOCTYPE html>
<html>
<head>
    <!-- JavaScript -->
    <script src="//unpkg.com/force-graph"></script>
    <script src="//unpkg.com/d3-quadtree"></script>
    <script src="//unpkg.com/d3-force"></script>
    <script src="//unpkg.com/element-resize-detector/dist/element-resize-detector.min.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="static/style.css">
    <!-- Favicon -->
    <link rel="icon" href="static/fffg_logo.svg" type="image/x-icon">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{{ app_name }}">
    <meta name="author" content="fedi follow force graph">
    <meta name="keywords" content="fediverse, mastodon, graph, force, d3, fedi follow force graph">
    <meta name="robots" content="index, follow">
    <title>{{ app_name }}</title>
</head>
<body>
    <!-- Full width background image  --> 
    <div class="fullWidthBackground">
        <img src="static/fffg_logo.svg" alt="fedi follow force graph log background" aria-hidden="true">
    </div>

    <!-- Flyout menu -->
    <div class="flyout">

        <div class="logo">
            <img src="static/fffg_logo.svg" alt="fedi follow force graph logo">
        </div>
  
        <nav>
            {% if logged_in %}
                <p>Welcome, {{ user.username }}!</p>
                <button onclick="window.location.href='/logout';">Logout</button>
            {% else %}
                <button onclick="window.location.href='/login';">Login with Mastodon</button>
            {% endif %}
            <!-- Buttons to show and hide nodes based on type-->
            <button onclick="filterNodes('follower');">Show Followers</button>
            <button onclick="filterNodes('following');">Show Followings</button>
            <button onclick="filterNodes('instance');">Show Instances</button>
            <button onclick="filterNodes('all');">Show All</button>

            <!-- Search component ToDo: Create component -->
            <form id="searchForUser">
                <input type="text" 
                    id="searchUser" 
                    placeholder="Search for a user" 
                    aria-label="Search for a user"
                    onkeyup="handleKeyUp(event)"
                >
                <button type="submit">Search</button>
            </form>
            <div id="searchResults"></div>

        </nav>

    </div>


    {{ graph | safe }}

    <div class="footer">

    </div>
    
    <script>
        
        let timeout = null;
        const delay = 1000;


        document.getElementById('searchForUser').addEventListener('submit', function(event) {
            event.preventDefault();  // Prevent the default form submission which causes page reload
            const query = document.getElementById('searchUser').value;
            fetch(`{{ api_base_url}}/search?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    displayResults(data);
                })
                .catch(error => console.error('Error:', error));
        });

        function displayResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = ''; // Clear previous results
            results.forEach(result => {
                const div = document.createElement('div');
                div.textContent = result.username;
                div.onclick = () => loadGraph(result.id); // Add click handler to load graph
                container.appendChild(div);
            });
        }

        async function loadGraph(userId) {
            const followers = await fetchAllItems(userId, 'followers', apiBaseUrl); 
            const followings = await fetchAllItems(userId, 'following', apiBaseUrl);
            // Generate graph data
            graphData = generateGraphData(userId, userName, userAvatar, followers, followings);
            // Calculate the number of connections for each node
            calculateNodeConnections(graphData.nodes, graphData.links);
            window.graph = initGraph(graphData);
        }

        async function handleKeyUp(event) {
            event.preventDefault();

            clearTimeout(timeout);

            // Check if the enter key is pressed
            if (event.key === "Enter") {
                submitForm();
            }
            else {
                timeout = setTimeout(submitForm, delay);
            }

        }

        async function submitForm() {
            const form = document.getElementById('searchForUser');
            form.submit();
        }

    </script>



    <!-- <script src="static/app.js"></script> -->



</body>
</html>


